<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link rel="stylesheet" href="data/style.css">
    <title>USERS</title>
    <style>
        ::placeholder {
            color: white;
            opacity: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="row mt-3 mb-3">
            <div class="col-1"><a id="returnbtn" href="index.html"><</a></div>
            <div class="col-10 text-center h3">USERS</div>
        </div>

        <div class="row">
            <div class="col-md-6">

                <div class="mb-3">
                    <input type="text" id="newUsername" class="form-control customborder" placeholder="Username">
                    <input type="email" id="newEmail" class="form-control customborder mt-2" placeholder="Email">
                    <input type="password" id="newPassword" class="form-control customborder mt-2"
                        placeholder="Password">
                    <button id="createUserBtn" class="btn btn-primary mt-2">ADD USER</button>
                </div>
            </div>

            <div class="col-md-6">

                <label for="userSelect">Select User ↓</label>
                <select id="userSelect" class="form-control customborder tall" size="10"></select>

                <div class="mt-2">
                    <input type="text" id="editUsername" class="form-control customborder" placeholder="Edit Username">
                    <input type="email" id="editEmail" class="form-control customborder mt-2" placeholder="Edit Email">
                    <input type="password" id="editPassword" class="form-control customborder mt-2"
                        placeholder="Edit Password">
                    <button id="updateUserBtn" class="btn btn-warning mt-2">UPDATE USER</button>
                    <button id="deleteUserBtn" class="btn btn-danger mt-2">DELETE USER</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const userSelect = document.getElementById('userSelect');
            const newUsername = document.getElementById('newUsername');
            const newEmail = document.getElementById('newEmail');
            const newPassword = document.getElementById('newPassword');
            const editUsername = document.getElementById('editUsername');
            const editEmail = document.getElementById('editEmail');
            const editPassword = document.getElementById('editPassword');


            const createUserBtn = document.getElementById('createUserBtn');
            const updateUserBtn = document.getElementById('updateUserBtn');
            const deleteUserBtn = document.getElementById('deleteUserBtn');

            let selectedUserId = null;

            function loadUsers() {
                fetch('/api/users')
                    .then(res => res.json())
                    .then(users => {
                        userSelect.innerHTML = '';
                        users.forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.Id;
                            option.textContent = user.Username + " (" + user.Email + ")";
                            userSelect.appendChild(option);
                        });
                    });
            }

            loadUsers();

            userSelect.addEventListener('change', function () {
                selectedUserId = userSelect.value;
                localStorage.setItem('userId', selectedUserId);

                const selectedOption = userSelect.selectedOptions[0];
                if (selectedOption) {
                    const text = selectedOption.textContent;
                    const match = text.match(/^(.+) \((.+)\)$/);
                    if (match) {
                        editUsername.value = match[1];
                        editEmail.value = match[2];
                        editPassword.value = '';
                    }
                }
            });

            createUserBtn.addEventListener('click', function () {
                const user = {
                    username: newUsername.value.trim(),
                    email: newEmail.value.trim(),
                    password: newPassword.value.trim()
                };
                if (!user.username || !user.email || !user.password) {
                    alert("Fill all fields!");
                    return;
                }

                fetch('/api/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                }).then(res => {
                    if (!res.ok) throw new Error("Failed to create user");
                    return res.json();
                }).then(() => {
                    alert("User added!");
                    newUsername.value = '';
                    newEmail.value = '';
                    newPassword.value = '';
                    loadUsers();
                }).catch(err => alert(err.message));
            });


            updateUserBtn.addEventListener('click', function () {
                if (!selectedUserId) {
                    alert("Select a user first!");
                    return;
                }

                const user = {
                    id: parseInt(selectedUserId),
                    username: editUsername.value.trim(),
                    email: editEmail.value.trim(),
                    password: editPassword.value.trim()
                };

                fetch('/api/users/' + selectedUserId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                }).then(res => {
                    if (!res.ok) throw new Error("Failed to update user");
                    return ;
                }).then(() => {
                    alert("User updated!");
                    loadUsers();
                }).catch(err => alert(err.message));
                loadUsers();
            });


            deleteUserBtn.addEventListener('click', function () {
                if (!selectedUserId) {
                    alert("Select a user first!");
                    return;
                }

                if (!confirm("Are you sure you want to delete this user?")) return;

                fetch('/api/users/' + selectedUserId, {
                    method: 'DELETE'
                }).then(res => {
                    if (!res.ok) throw new Error("Failed to delete user");
                    return res.text();
                }).then(() => {
                    alert("User deleted!");
                    localStorage.removeItem('userId');
                    selectedUserId = null;
                    editUsername.value = '';
                    editEmail.value = '';
                    editPassword.value = '';
                    loadUsers();
                }).catch(err => alert(err.message));
            });
        });
    </script>
</body>

</html>
